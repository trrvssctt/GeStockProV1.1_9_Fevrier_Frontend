Plan : BASIC

En te basnt sur l fichier #file:authBridge.ts 

1Ô∏è‚É£ Identification du plan

Nom du plan : Basic

Identifiant unique : BASIC

2Ô∏è‚É£ Modules inclus (tous ACTIV√âS)

Les modules suivants doivent √™tre disponibles dans le plan BASIC, avec une impl√©mentation fonctionnelle simple :

Cat√©gories

Sous-cat√©gories

Catalogue de stocks (produits stockables)

Catalogue de services (services non stockables)

Clients

Ventes et Factures

Tr√©sorerie

Gouvernance IAM (gestion des utilisateurs et acc√®s)

Abonnement

Param√®tres

‚ö†Ô∏è Aucun module suppl√©mentaire ne doit √™tre ajout√©.

3Ô∏è‚É£ Description fonctionnelle des modules

Cat√©gories : gestion simple des cat√©gories (CRUD autoris√©).

Sous-cat√©gories : rattach√©es obligatoirement √† une cat√©gorie existante.

Catalogue de stocks : produits avec prix et quantit√©.

Catalogue de services : services sans notion de stock.

Clients : utilis√©s pour les ventes et factures.

Ventes et Factures : cr√©ation de ventes et g√©n√©ration de factures basiques.

Tr√©sorerie : suivi simple des entr√©es li√©es aux ventes.

Gouvernance IAM : gestion des utilisateurs avec r√¥les simples.

Abonnement : affichage du plan actif et de ses limites.

Param√®tres : configuration g√©n√©rale basique.

Aucune fonctionnalit√© avanc√©e ne doit √™tre impl√©ment√©e.

4Ô∏è‚É£ Limites fonctionnelles obligatoires

Tu dois bloquer toute action d√©passant les limites suivantes :

üî∏ Clients

Maximum autoris√© : 5 clients

Action √† effectuer au d√©passement :

Refuser la cr√©ation

Afficher le message :

"Limite du plan Basic atteinte : maximum 5 clients."

üî∏ Utilisateurs

Maximum autoris√© : 3 utilisateurs (administrateur inclus)

Blocage strict au-del√† de cette limite.

üî∏ Ventes mensuelles

Maximum autoris√© : 20 ventes par mois

Le compteur :

Est bas√© sur la date de cr√©ation de la vente

Est r√©initialis√© automatiquement chaque mois

Action au d√©passement :

Refuser la cr√©ation de la vente

Afficher un message clair indiquant la limite mensuelle atteinte

5Ô∏è‚É£ R√®gles d‚Äôimpl√©mentation imp√©ratives

Toutes les limites doivent √™tre contr√¥l√©es au niveau de la logique m√©tier.

Aucune tol√©rance ou d√©passement temporaire n‚Äôest autoris√©.

Aucun module n‚Äôest d√©sactiv√©, seuls les volumes sont limit√©s.

Toute action bloqu√©e doit retourner :

Un refus explicite

Un message compr√©hensible pour l‚Äôutilisateur

Ne jamais supposer l‚Äôexistence de fonctionnalit√©s non d√©crites ici.

6Ô∏è‚É£ Comportement attendu

Impl√©menter uniquement ce qui est d√©fini.

Ne pas proposer d‚Äôoptions avanc√©es.

Ne pas modifier les r√®gles.

Ne pas compl√©ter ou enrichir le plan BASIC.

Conform√©ment √† vos directives strictes pour le plan BASIC, les modifications suivantes sont apport√©es :

    Gouvernance des Acc√®s (services/authBridge.ts) :

        Verrouillage du p√©rim√®tre √† 10 modules exactement : dashboard, categories, subcategories, inventory, services, customers, sales, payments (Tr√©sorerie), governance, subscription, settings.

        Exclusion de tous les autres modules (Audit, S√©curit√©, IA, Recouvrement).

    Gestion des Quotas (authBridge.ts, Customers.tsx, Governance.tsx, Sales.tsx) :

        Clients : Blocage √† 5. Message d'erreur : "Limite du plan Basic atteinte : maximum 5 clients."

        Utilisateurs : Blocage √† 3 (Admin inclus).

        Ventes : Blocage √† 20 par mois calendaire. Calcul bas√© sur le mois en cours.



Plan : Business Pro

En te basnt sur l fichier #file:authBridge.ts 

1Ô∏è‚É£ Identification du plan

Nom du plan : Basic

Identifiant unique : PRO

2Ô∏è‚É£ Modules inclus (tous ACTIV√âS)

Les modules suivants doivent √™tre disponibles dans le plan PRO, avec une impl√©mentation fonctionnelle simple :

Tous les modules du plan BASIC

Audit : suivi des actions utilisateurs

S√©curit√© : gestion des mots de passe et des acc√®s

Recouvrement : gestion des relances clients

Mouvement de Flux

Inventaire

‚ö†Ô∏è Aucun module suppl√©mentaire ne doit √™tre ajout√©.

3Ô∏è‚É£ Description fonctionnelle des modules

Audit

Suivi des actions utilisateurs

S√©curit√©

Gestion des mots de passe et des acc√®s

Recouvrement

Gestion des relances clients

Aucune fonctionnalit√© avanc√©e ne doit √™tre impl√©ment√©e.

4Ô∏è‚É£ Limites fonctionnelles obligatoires

Tu dois bloquer toute action d√©passant les limites suivantes :

üî∏ Clients

Maximum autoris√© : 12 clients

Action √† effectuer au d√©passement :

Refuser la cr√©ation

Afficher le message :

"Limite du plan PRO atteinte : maximum 12 clients."

üî∏ Utilisateurs

Maximum autoris√© : 10 utilisateurs (administrateur inclus)

Blocage strict au-del√† de cette limite.

üî∏ Ventes mensuelles

Maximum autoris√© : 50 ventes par mois

Le compteur :

Est bas√© sur la date de cr√©ation de la vente

Est r√©initialis√© automatiquement chaque mois

Action au d√©passement :

Refuser la cr√©ation de la vente

Afficher un message clair indiquant la limite mensuelle atteinte

5Ô∏è‚É£ R√®gles d‚Äôimpl√©mentation imp√©ratives

Toutes les limites doivent √™tre contr√¥l√©es au niveau de la logique m√©tier.

Aucune tol√©rance ou d√©passement temporaire n‚Äôest autoris√©.

Aucun module n‚Äôest d√©sactiv√©, seuls les volumes sont limit√©s.

Toute action bloqu√©e doit retourner :

Un refus explicite

Un message compr√©hensible pour l‚Äôutilisateur

Ne jamais supposer l‚Äôexistence de fonctionnalit√©s non d√©crites ici.

6Ô∏è‚É£ Comportement attendu

Impl√©menter uniquement ce qui est d√©fini.

Ne pas proposer d‚Äôoptions avanc√©es.

Ne pas modifier les r√®gles.

Ne pas compl√©ter ou enrichir le plan BASIC.

Conform√©ment √† vos directives strictes pour le plan PRO, les modifications suivantes sont apport√©es :

    Gouvernance des Acc√®s (services/authBridge.ts) :

        Verrouillage du p√©rim√®tre √† 10 modules exactement : dashboard, categories, subcategories, inventory, services, customers, sales, payments (Tr√©sorerie), governance, subscription, settings,Audit,Inventaire,Mouvement de Flux, Recouvrement, S√©curit√©

        Exclusion de tous les autres modules (IA).

    Gestion des Quotas (authBridge.ts, Customers.tsx, Governance.tsx, Sales.tsx) :

        Clients : Blocage √† 12. Message d'erreur : "Limite du plan PRO atteinte : maximum 12 clients."

        Utilisateurs : Blocage √† 10 (Admin inclus).

        Ventes : Blocage √† 50 par mois calendaire. Calcul bas√© sur le mois en cours.



Plan : Enterprise Cloud

En te basnt sur l fichier #file:authBridge.ts 

1Ô∏è‚É£ Identification du plan

Nom du plan : Enterprise Cloud

Identifiant unique : ENTERPRISE

2Ô∏è‚É£ Modules inclus (tous ACTIV√âS)

Les modules suivants doivent √™tre disponibles dans le plan ENTERPRISE, avec une impl√©mentation fonctionnelle simple :

Tous les modules du plan PRO

IA


‚ö†Ô∏è Aucun module suppl√©mentaire ne doit √™tre ajout√©.

3Ô∏è‚É£ Description fonctionnelle des modules

IA

4Ô∏è‚É£ Limites fonctionnelles obligatoires

Pas de limite

5Ô∏è‚É£ R√®gles d‚Äôimpl√©mentation imp√©ratives

Toutes les limites doivent √™tre contr√¥l√©es au niveau de la logique m√©tier.

Aucune tol√©rance ou d√©passement temporaire n‚Äôest autoris√©.

Aucun module n‚Äôest d√©sactiv√©, seuls les volumes sont limit√©s.

Toute action bloqu√©e doit retourner :

Un refus explicite

Un message compr√©hensible pour l‚Äôutilisateur

Ne jamais supposer l‚Äôexistence de fonctionnalit√©s non d√©crites ici.

6Ô∏è‚É£ Comportement attendu

Impl√©menter uniquement ce qui est d√©fini.

Ne pas proposer d‚Äôoptions avanc√©es.

Ne pas modifier les r√®gles.

Ne pas compl√©ter ou enrichir le plan BASIC.

Conform√©ment √† vos directives strictes pour le plan PRO, les modifications suivantes sont apport√©es :

    Gouvernance des Acc√®s (services/authBridge.ts) :

        Tous les modules sont autoris√©s.

    Gestion des Quotas (authBridge.ts, Customers.tsx, Governance.tsx, Sales.tsx) :

        Pas de limite





import { User, UserRole } from '../types';

const AUTH_STORAGE_KEY = 'gsp_session_vault';

/**
 * D√©finition stricte des plans
 */
const PLAN_RULES = {
  BASIC: {
    modules: [
      'dashboard',
      'categories',
      'subcategories',
      'inventory',
      'movements',
      'services',
      'customers',
      'sales',
      'payments',     // Tr√©sorerie
      'governance',
      'subscription',
      'settings'
    ],
    limits: {
      customers: 5,
      users: 3,
      monthlySales: 20
    }
  },
  PRO: {
    modules: [
      'dashboard',
      'categories',
      'subcategories',
      'inventory',
      'services',
      'customers',
      'sales',
      'payments',
      'governance',
      'subscription',
      'settings',
      'audit',
      'security',
      'recovery',
      'movements'
    ],
    limits: {
      customers: 12,
      users: 10,
      monthlySales: 50
    }
  },
  ENTERPRISE: {
    modules: ['*'], // Tous les modules autoris√©s
    limits: null    // Aucune limite
  }
};

export const authBridge = {
  saveSession: (user: User, token: string) => {
    let roles: UserRole[] = [];

    if (Array.isArray(user.roles) && user.roles.length > 0) {
      roles = user.roles;
    } else if (user.role) {
      roles = [user.role];
    } else {
      roles = [UserRole.SALES];
    }

    const sessionUser = { ...user, roles };
    sessionStorage.setItem(
      AUTH_STORAGE_KEY,
      JSON.stringify({ user: sessionUser, token, timestamp: Date.now() })
    );
  },

  getSession: (): { user: User; token: string } | null => {
    const raw = sessionStorage.getItem(AUTH_STORAGE_KEY);
    if (!raw) return null;

    try {
      const data = JSON.parse(raw);
      if (Date.now() - data.timestamp > 86400000) {
        authBridge.clearSession();
        return null;
      }
      return data;
    } catch {
      return null;
    }
  },

  fetchMe: async (token: string): Promise<User | null> => {
    try {
      const response = await fetch('http://localhost:3000/api/auth/me', {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!response.ok) return null;

      const user = await response.json();
      return {
        ...user,
        roles: Array.isArray(user.roles) ? user.roles : [user.role]
      };
    } catch {
      return null;
    }
  },

  clearSession: () => sessionStorage.removeItem(AUTH_STORAGE_KEY),

  /**
   * üîê Gouvernance des acc√®s par PLAN + R√îLE
   */
  canAccess: (user: User, moduleId: string): boolean => {
    const roles = Array.isArray(user.roles) ? user.roles : [user.role];
    const planId = (user as any).planId || 'BASIC';

    // SUPER ADMIN : acc√®s total
    //if (roles.includes(UserRole.SUPER_ADMIN)) return true;

    const plan = PLAN_RULES[planId as keyof typeof PLAN_RULES] || PLAN_RULES.BASIC;

    // ENTERPRISE : tous les modules
    if (plan.modules.includes('*')) return true;

    // Verrouillage strict du p√©rim√®tre du plan
    if (!plan.modules.includes(moduleId)) return false;

    // ADMIN : acc√®s √† tous les modules du plan
    if (roles.includes(UserRole.ADMIN)) return true;

    const roleMap: Record<string, string[]> = {
      [UserRole.SALES]: ['dashboard', 'sales', 'customers'],
      [UserRole.STOCK_MANAGER]: [
        'dashboard',
        'categories',
        'subcategories',
        'inventory',
        'movements',
        'services'
      ],
      [UserRole.ACCOUNTANT]: [
        'dashboard',
        'sales',
        'payments',
        'customers',
        'services',
        'recovery'
      ],
      ['EMPLOYEE' as any]: ['dashboard', 'inventory', 'customers', 'services']
    };

    return roles.some(r => (roleMap[r as any] || []).includes(moduleId));
  },

  /**
   * üö´ Gestion des quotas par PLAN
   */
  canPerform: (
    user: User,
    action: 'CREATE' | 'EDIT' | 'DELETE' | 'VIEW',
    resource: string
  ): boolean => {
    const roles = Array.isArray(user.roles) ? user.roles : [user.role];
    const planId = (user as any).planId || 'BASIC';

    // SUPER ADMIN / ADMIN : pas de restriction
    /*if (roles.includes(UserRole.SUPER_ADMIN) || roles.includes(UserRole.ADMIN)) {
      return true;
    }*/

    const plan = PLAN_RULES[planId as keyof typeof PLAN_RULES] || PLAN_RULES.BASIC;

    // ENTERPRISE : aucune limite
    if (!plan.limits) return true;

    if (action === 'CREATE') {
      if (resource === 'customers' && (user as any).customersCount >= plan.limits.customers) {
        return false;
      }

      if (resource === 'users' && (user as any).usersCount >= plan.limits.users) {
        return false;
      }

      if (
        resource === 'sales' &&
        (user as any).monthlySalesCount >= plan.limits.monthlySales
      ) {
        return false;
      }
    }

    return roles.some(r => {
      if (r === UserRole.STOCK_MANAGER) {
        return ['categories', 'subcategories', 'inventory', 'movements', 'services'].includes(resource);
      }
      if (r === UserRole.SALES) {
        if (['sales', 'customers', 'services'].includes(resource)) return true;
        return action === 'VIEW' && resource === 'inventory';
      }
      if (r === UserRole.ACCOUNTANT) {
        if (['payments', 'settings', 'recovery', 'services'].includes(resource)) return true;
        return action === 'VIEW';
      }
      return action === 'VIEW';
    });
  }
  ,

  /**
   * Retourne les limites du plan de l'utilisateur (ou null si illimit√©)
   */
  getPlanLimits: (user: User) => {
    const planId = (user as any).planId || 'BASIC';
    const plan = PLAN_RULES[planId as keyof typeof PLAN_RULES] || PLAN_RULES.BASIC;
    return plan.limits || null;
  },

  /**
   * V√©rifie si la cr√©ation d'une ressource est autoris√©e en fonction des limites du plan
   * resource: 'customers' | 'users' | 'sales'
   * currentCount: nombre actuel (pour sales on passe le compteur mensuel)
   */
  isCreationAllowed: (user: User, resource: string, currentCount: number) => {
    const planId = (user as any).planId || 'BASIC';
    const plan = PLAN_RULES[planId as keyof typeof PLAN_RULES] || PLAN_RULES.BASIC;
    const limits = plan.limits;
    if (!limits) return true; // unlimited (Enterprise)

    if (resource === 'customers') {
      return currentCount < limits.customers;
    }
    if (resource === 'users') {
      return currentCount < limits.users;
    }
    if (resource === 'sales') {
      return currentCount < limits.monthlySales;
    }
    return true;
  }
};